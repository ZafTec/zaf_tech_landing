---
import Layout from "@/layouts/Layout.astro";

// Section components
import Hero from "@/components/sections/Hero.astro";
import Features from "@/components/sections/Features.astro";
import About from "@/components/sections/About.astro";
import Services from "@/components/sections/Services.astro";
import Gallery from "@/components/sections/Gallery.astro";
import Team from "@/components/sections/Team.astro";
import Testimonials from "@/components/sections/Testimonials.astro";
import Contact from "@/components/sections/Contact.astro";

// Data imports
import { images, features, services, gallery, team, testimonials } from "@/data/content";

export const prerender = true;

const nav = [
  { label: "Features", href: "#features" },
  { label: "About", href: "#about" },
  { label: "Services", href: "#services" },
  { label: "Gallery", href: "#portfolio" },
  { label: "Team", href: "#team" },
  { label: "Testimonials", href: "#testimonials" },
  { label: "Contact", href: "#contact" },
];
---
<Layout title="ZafTech | Web and RAG Studio">
  <div class="bg-bg text-ink" id="page-top">
    <header class="fixed inset-x-0 top-0 z-40 border-b border-white/10 transition-all duration-300" style="background-color: rgba(0, 0, 0, 0); backdrop-filter: blur(0px);">
      <div class="relative mx-auto flex max-w-6xl items-center justify-between px-4 py-4">
        <div class="flex items-center gap-3">
          <img src="/logo.png" alt="ZafTech Logo" class="h-11 w-auto" />
        </div>
        <nav
          class="absolute left-1/2 top-1/2 hidden -translate-y-1/2 items-center gap-6 text-sm font-semibold text-white/70 lg:flex"
          aria-label="Primary"
          data-nav-root
        >
          {nav.map((item) => (
            <a
              class="nav-link transition hover:text-white"
              href={item.href}
              data-nav={item.href.replace("#", "")}
            >
              {item.label}
            </a>
          ))}
          <span class="nav-indicator" aria-hidden="true"></span>
        </nav>
      </div>
    </header>

    <main>
      <Hero heroImage={images.hero} />
      <Features features={features} />
      <About aboutImage={images.about} />
      <Services services={services} />
      <Gallery gallery={gallery} />
      <Team team={team} />
      <Testimonials testimonials={testimonials} />
      <Contact />
    </main>

    <footer class="border-t border-border py-8">
      <div class="mx-auto flex max-w-6xl flex-wrap items-center justify-between gap-4 px-4 text-sm text-ink-muted">
        <p> &copy; 2026 ZafTech. All rights reserved.</p>
        <div class="flex gap-4">
          <a href="#features" class="hover:text-ink">Features</a>
          <a href="#portfolio" class="hover:text-ink">Gallery</a>
          <a href="#contact" class="hover:text-ink">Contact</a>
        </div>
      </div>
    </footer>
  </div>

  <script is:inline>
    // Navbar scroll effect
    const header = document.querySelector("header");

    const updateNavbar = () => {
      const scrollY = window.scrollY;

      if (scrollY > 50) {
        header.style.backgroundColor = "rgba(0, 0, 0, 0.6)";
        header.style.backdropFilter = "blur(32px)";
      } else {
        header.style.backgroundColor = "rgba(0, 0, 0, 0)";
        header.style.backdropFilter = "blur(0px)";
      }
    };

    window.addEventListener("scroll", updateNavbar, { passive: true });
    updateNavbar(); // Initial call

    const navRoot = document.querySelector("[data-nav-root]");
    const indicator = navRoot?.querySelector(".nav-indicator");
    const links = Array.from(document.querySelectorAll("[data-nav]"));
    const sections = links
      .map((link) => document.querySelector(`#${link.dataset.nav}`))
      .filter(Boolean);
    const hero = document.querySelector("#hero");
    const observed = [...sections, hero].filter(Boolean);
    const ratios = new Map();
    let observer;

    const setActive = (id) => {
      links.forEach((link) => {
        link.classList.toggle("is-active", link.dataset.nav === id);
      });
      updateIndicator();
    };

    const updateIndicator = () => {
      if (!navRoot || !indicator) {
        return;
      }
      const active = navRoot.querySelector(".nav-link.is-active");
      if (!active) {
        indicator.style.opacity = "0";
        indicator.style.width = "0px";
        return;
      }
      const rect = active.getBoundingClientRect();
      const navRect = navRoot.getBoundingClientRect();
      const left = rect.left - navRect.left;
      indicator.style.opacity = "1";
      indicator.style.width = `${rect.width}px`;
      indicator.style.transform = `translateX(${left}px)`;
    };

    const syncNavOffset = () => {
      const header = document.querySelector("header");
      const offset = header ? header.offsetHeight + 16 : 88;
      document.documentElement.style.setProperty("--nav-offset", `${offset}px`);
      return offset;
    };

    const createObserver = () => {
      const offset = syncNavOffset();
      if (observer) {
        observer.disconnect();
      }
      observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            ratios.set(entry.target.id, entry.isIntersecting ? entry.intersectionRatio : 0);
          });

          const sorted = Array.from(ratios.entries()).sort((a, b) => b[1] - a[1]);
          const [id, ratio] = sorted[0] ?? [];

          if (!id || ratio === 0 || id === "hero") {
            setActive(null);
            return;
          }
          setActive(id);
        },
        {
          rootMargin: `-${offset}px 0px -55% 0px`,
          threshold: [0.05, 0.2, 0.5],
        }
      );

      observed.forEach((section) => observer.observe(section));
    };

    let resizeTimer;
    window.addEventListener("resize", () => {
      window.clearTimeout(resizeTimer);
      resizeTimer = window.setTimeout(() => {
        createObserver();
        updateIndicator();
      }, 120);
    });

    createObserver();
    updateIndicator();

    const form = document.querySelector("[data-contact-form]");
    const status = document.querySelector("[data-form-status]");

    if (form) {
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (status) {
          status.textContent = "Sending...";
        }
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        try {
          const response = await fetch("/api/contact", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error("Failed to submit");
          }

          form.reset();
          if (status) {
            status.textContent = "Thanks! We'll be in touch shortly.";
          }
        } catch (error) {
          if (status) {
            status.textContent = "Something went wrong. Please email hello@zaftech.com.";
          }
        }
      });
    }
  </script>
</Layout>

