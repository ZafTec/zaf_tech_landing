---
import Layout from "@/layouts/Layout.astro";

// Section components
import Hero from "@/components/sections/Hero.astro";
import Features from "@/components/sections/Features.astro";
import About from "@/components/sections/About.astro";
import Services from "@/components/sections/Services.astro";
import Products from "@/components/sections/Products.astro";
import Gallery from "@/components/sections/Gallery.astro";
import Team from "@/components/sections/Team.astro";
// import Testimonials from "@/components/sections/Testimonials.astro";
import Contact from "@/components/sections/Contact.astro";

// Data imports
import { images, features, services, products, gallery, team } from "@/data/content";

export const prerender = true;

const nav = [
  { label: "Features", href: "#features" },
  { label: "Products", href: "#products" },
  { label: "About", href: "#about" },
  { label: "Services", href: "#services" },
  { label: "Gallery", href: "#portfolio" },
  { label: "Team", href: "#team" },
  // { label: "Testimonials", href: "#testimonials" },
  { label: "Contact", href: "#contact" },
];
---
<Layout title="ZafTech | Full-stack Development & Machine Learning">
  <div class="bg-bg text-ink" id="page-top">
    <header class="fixed inset-x-0 top-0 z-40 border-b border-transparent transition-all duration-300" style="background-color: rgba(0, 0, 0, 0); backdrop-filter: blur(0px);" data-header>
      <div class="relative mx-auto flex max-w-6xl items-center justify-between px-4 py-4">
        <div class="flex items-center gap-3">
          <div class="flex h-11 w-11 items-center justify-center rounded-xl bg-contrast dark:bg-white text-white dark:text-black shadow-soft">
            Z
          </div>
          <div>
            <p class="text-base font-semibold text-ink dark:text-white">ZafTech</p>
          </div>
        </div>
        <nav
          class="absolute left-1/2 top-1/2 hidden -translate-y-1/2 -translate-x-1/2 items-center gap-6 text-sm font-semibold text-ink/70 dark:text-white/70 lg:flex"
          aria-label="Primary"
          data-nav-root
        >
          {nav.map((item) => (
            <a
              class="nav-link transition hover:text-ink dark:hover:text-white"
              href={item.href}
              data-nav={item.href.replace("#", "")}
            >
              {item.label}
            </a>
          ))}
          <span class="nav-indicator" aria-hidden="true"></span>
        </nav>
      </div>
    </header>

    <main>
      <Hero />
      <Features features={features} />
      <Products products={products} />
      <About aboutImage={images.about} />
      <Services services={services} />
      <Gallery gallery={gallery} />
      <Team team={team} />
      <!-- TODO: Populate testimonials section -->
      <!-- <Testimonials testimonials={testimonials} /> -->
      <Contact />
    </main>

    <footer class="border-t border-border py-8">
      <div class="mx-auto flex max-w-6xl flex-wrap items-center justify-between gap-4 px-4 text-sm text-ink-muted">
        <p> &copy; 2026 ZafTech. All rights reserved.</p>
        <div class="flex gap-4">
          <a href="#features" class="hover:text-ink">Features</a>
          <a href="#portfolio" class="hover:text-ink">Gallery</a>
          <a href="#contact" class="hover:text-ink">Contact</a>
        </div>
      </div>
    </footer>
  </div>

  <script is:inline>
    const header = document.querySelector("header");
    const isDarkMode = () => window.matchMedia('(prefers-color-scheme: dark)').matches;

    const updateNavbar = () => {
      const scrollY = window.scrollY;
      const dark = isDarkMode();

      if (scrollY > 50) {
        header.style.backgroundColor = dark ? "rgba(0, 0, 0, 0.6)" : "rgba(255, 255, 255, 0.85)";
        header.style.backdropFilter = "blur(32px)";
        header.style.borderColor = dark ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.1)";
      } else {
        header.style.backgroundColor = "rgba(0, 0, 0, 0)";
        header.style.backdropFilter = "blur(0px)";
        header.style.borderColor = "transparent";
      }
    };
    
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateNavbar);
    window.addEventListener("scroll", updateNavbar, { passive: true });
    updateNavbar();

    const navRoot = document.querySelector("[data-nav-root]");
    const indicator = navRoot?.querySelector(".nav-indicator");
    const links = Array.from(document.querySelectorAll("[data-nav]"));

    const scrollToSection = (id) => {
      const element = document.querySelector(`#${id}`);
      if (!element) return;
      
      const headerHeight = header?.offsetHeight || 72;
      const elementPosition = element.getBoundingClientRect().top;
      const offsetPosition = elementPosition + window.pageYOffset - headerHeight;

      window.scrollTo({
        top: offsetPosition,
        behavior: "smooth"
      });
    };

    links.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const id = link.dataset.nav;
        scrollToSection(id);
      });
    });

    const setActive = (id) => {
      links.forEach((link) => {
        link.classList.toggle("is-active", link.dataset.nav === id);
      });
      updateIndicator();
    };

    const updateIndicator = () => {
      if (!navRoot || !indicator) return;
      const active = navRoot.querySelector(".nav-link.is-active");
      if (!active) {
        indicator.style.opacity = "0";
        indicator.style.width = "0px";
        return;
      }
      const rect = active.getBoundingClientRect();
      const navRect = navRoot.getBoundingClientRect();
      const left = rect.left - navRect.left;
      indicator.style.opacity = "1";
      indicator.style.width = `${rect.width}px`;
      indicator.style.transform = `translateX(${left}px)`;
    };

    const sections = links.map((link) => document.querySelector(`#${link.dataset.nav}`)).filter(Boolean);
    const hero = document.querySelector("#hero");
    
    // Track visibility of each section
    const visibility = new Map();
    let activeSection = null;

    const observer = new IntersectionObserver(
      (entries) => {
        // Update visibility tracking
        entries.forEach(entry => {
          visibility.set(entry.target.id, entry.intersectionRatio);
        });

        const heroVisible = visibility.get("hero") || 0;
        
        // Hide indicator when hero is visible
        if (heroVisible > 0.3) {
          setActive(null);
          return;
        }

        // Find most visible section
        let bestSection = null;
        let bestRatio = 0;
        
        sections.forEach(section => {
          const ratio = visibility.get(section.id) || 0;
          if (ratio > bestRatio) {
            bestRatio = ratio;
            bestSection = section.id;
          }
        });

        // If we have a visible section, make it active
        if (bestSection && bestRatio > 0) {
          activeSection = bestSection;
          setActive(bestSection);
        } 
        // Otherwise keep showing the last active section (no disappearing in gaps!)
        else if (activeSection) {
          setActive(activeSection);
        }
      },
      { 
        rootMargin: "-80px 0px -40% 0px",
        threshold: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1]
      }
    );

    // Observe all sections and hero
    sections.forEach(section => observer.observe(section));
    if (hero) observer.observe(hero);
    
    updateIndicator();

    // Contact form
    document.querySelector("[data-contact-form]")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const status = document.querySelector("[data-form-status]");
      if (status) status.textContent = "Sending...";
      
      try {
        const response = await fetch("/api/contact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(Object.fromEntries(new FormData(e.target))),
        });
        if (!response.ok) throw new Error("Failed");
        e.target.reset();
        if (status) status.textContent = "Thanks! We'll be in touch shortly.";
      } catch {
        if (status) status.textContent = "Something went wrong. Please email contact@zaftech.co.";
      }
    });
  </script>
</Layout>

