---
import Layout from "@/layouts/Layout.astro";

// Section components
import Hero from "@/components/sections/Hero.astro";
import Features from "@/components/sections/Features.astro";
import About from "@/components/sections/About.astro";
import Services from "@/components/sections/Services.astro";
import Products from "@/components/sections/Products.astro";
import Gallery from "@/components/sections/Gallery.astro";
import Team from "@/components/sections/Team.astro";
// import Testimonials from "@/components/sections/Testimonials.astro";
import Contact from "@/components/sections/Contact.astro";

// Data imports
import { images, features, services, products, gallery, team } from "@/data/content";

export const prerender = true;

const nav = [
  { label: "Features", href: "#features" },
  { label: "Products", href: "#products" },
  { label: "About", href: "#about" },
  { label: "Services", href: "#services" },
  { label: "Gallery", href: "#portfolio" },
  { label: "Team", href: "#team" },
  // { label: "Testimonials", href: "#testimonials" },
  { label: "Contact", href: "#contact" },
];
---
<Layout title="ZafTech | Full-stack Development & Machine Learning">
  <div class="bg-bg text-ink" id="page-top">
    <header class="fixed inset-x-0 top-0 z-40 border-b border-transparent transition-all duration-300" style="background-color: rgba(0, 0, 0, 0); backdrop-filter: blur(0px);" data-header>
      <div class="relative mx-auto flex max-w-6xl items-center justify-between px-4 py-4">
        <div class="flex items-center gap-3">
          <div class="flex h-11 w-11 items-center justify-center rounded-xl bg-contrast dark:bg-white text-white dark:text-black shadow-soft">
            Z
          </div>
          <div>
            <p class="text-base font-semibold text-ink dark:text-white">ZafTech</p>
          </div>
        </div>
        <nav
          class="absolute left-1/2 top-1/2 hidden -translate-y-1/2 -translate-x-1/2 items-center gap-6 text-sm font-semibold text-ink/70 dark:text-white/70 lg:flex"
          aria-label="Primary"
          data-nav-root
        >
          {nav.map((item) => (
            <a
              class="nav-link transition hover:text-ink dark:hover:text-white"
              href={item.href}
              data-nav={item.href.replace("#", "")}
            >
              {item.label}
            </a>
          ))}
          <span class="nav-indicator" aria-hidden="true"></span>
        </nav>
      </div>
    </header>

    <main>
      <Hero />
      <Features features={features} />
      <Products products={products} />
      <About aboutImage={images.about} />
      <Services services={services} />
      <Gallery gallery={gallery} />
      <Team team={team} />
      <!-- TODO: Populate testimonials section -->
      <!-- <Testimonials testimonials={testimonials} /> -->
      <Contact />
    </main>

    <footer class="border-t border-border py-8">
      <div class="mx-auto flex max-w-6xl flex-wrap items-center justify-between gap-4 px-4 text-sm text-ink-muted">
        <p> &copy; 2026 ZafTech. All rights reserved.</p>
        <div class="flex gap-4">
          <a href="#features" class="hover:text-ink">Features</a>
          <a href="#portfolio" class="hover:text-ink">Gallery</a>
          <a href="#contact" class="hover:text-ink">Contact</a>
        </div>
      </div>
    </footer>
  </div>

  <script is:inline>
    // Navbar scroll effect
    const header = document.querySelector("header");

    // Detect dark mode
    const isDarkMode = () => window.matchMedia('(prefers-color-scheme: dark)').matches;

    const updateNavbar = () => {
      const scrollY = window.scrollY;
      const dark = isDarkMode();

      if (scrollY > 50) {
        // Light mode: light background, Dark mode: dark background
        header.style.backgroundColor = dark ? "rgba(0, 0, 0, 0.6)" : "rgba(255, 255, 255, 0.85)";
        header.style.backdropFilter = "blur(32px)";
        header.style.borderColor = dark ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.1)";
      } else {
        header.style.backgroundColor = "rgba(0, 0, 0, 0)";
        header.style.backdropFilter = "blur(0px)";
        header.style.borderColor = "transparent";
      }
    };
    
    // Listen for theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateNavbar);

    window.addEventListener("scroll", updateNavbar, { passive: true });
    updateNavbar(); // Initial call

    const navRoot = document.querySelector("[data-nav-root]");
    const indicator = navRoot?.querySelector(".nav-indicator");
    const links = Array.from(document.querySelectorAll("[data-nav]"));
    const sections = links
      .map((link) => document.querySelector(`#${link.dataset.nav}`))
      .filter(Boolean);
    const hero = document.querySelector("#hero");
    const observed = [...sections, hero].filter(Boolean);
    const ratios = new Map();
    let observer;

    const setActive = (id) => {
      links.forEach((link) => {
        link.classList.toggle("is-active", link.dataset.nav === id);
      });
      updateIndicator();
    };

    const updateIndicator = () => {
      if (!navRoot || !indicator) {
        return;
      }
      const active = navRoot.querySelector(".nav-link.is-active");
      if (!active) {
        indicator.style.opacity = "0";
        indicator.style.width = "0px";
        return;
      }
      const rect = active.getBoundingClientRect();
      const navRect = navRoot.getBoundingClientRect();
      const left = rect.left - navRect.left;
      indicator.style.opacity = "1";
      indicator.style.width = `${rect.width}px`;
      indicator.style.transform = `translateX(${left}px)`;
    };

    const syncNavOffset = () => {
      const header = document.querySelector("header");
      const offset = header ? header.offsetHeight + 16 : 88;
      document.documentElement.style.setProperty("--nav-offset", `${offset}px`);
      return offset;
    };

    const createObserver = () => {
      const offset = syncNavOffset();
      if (observer) {
        observer.disconnect();
      }

      // Track the best matching section
      let bestSection = null;
      let bestScore = -Infinity;

      observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const rect = entry.boundingClientRect;
            const viewportHeight = window.innerHeight;
            const offsetVal = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--nav-offset')) || 88;

            // Calculate how centered the section is in the viewport (below navbar)
            const sectionCenter = rect.top + rect.height / 2;
            const viewportCenter = offsetVal + (viewportHeight - offsetVal) / 2;
            const distanceFromCenter = Math.abs(sectionCenter - viewportCenter);

            // Score: higher is better (closer to center, more visible)
            const visibilityScore = entry.isIntersecting ? entry.intersectionRatio : 0;
            const centerScore = Math.max(0, 1 - distanceFromCenter / (viewportHeight / 2));
            const totalScore = visibilityScore * 0.6 + centerScore * 0.4;

            ratios.set(entry.target.id, totalScore);
          });

          // Find section with highest score
          const sorted = Array.from(ratios.entries()).sort((a, b) => b[1] - a[1]);
          const [id, score] = sorted[0] ?? [];

          // Only update if we have a valid, visible section
          if (!id || score < 0.05 || id === "hero") {
            setActive(null);
            return;
          }

          // Only update if this is a better match or significant change
          if (score > bestScore || (bestSection && Math.abs(score - bestScore) > 0.1)) {
            bestScore = score;
            bestSection = id;
            setActive(id);
          }
        },
        {
          rootMargin: `-${offset}px 0px -30% 0px`,
          threshold: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1],
        }
      );

      observed.forEach((section) => observer.observe(section));
    };

    let resizeTimer;
    window.addEventListener("resize", () => {
      window.clearTimeout(resizeTimer);
      resizeTimer = window.setTimeout(() => {
        createObserver();
        updateIndicator();
      }, 120);
    });

    createObserver();
    updateIndicator();

    const form = document.querySelector("[data-contact-form]");
    const status = document.querySelector("[data-form-status]");

    if (form) {
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (status) {
          status.textContent = "Sending...";
        }
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        try {
          const response = await fetch("/api/contact", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error("Failed to submit");
          }

          form.reset();
          if (status) {
            status.textContent = "Thanks! We'll be in touch shortly.";
          }
        } catch (error) {
          if (status) {
            status.textContent = "Something went wrong. Please email hello@zaftech.com.";
          }
        }
      });
    }
  </script>
</Layout>

